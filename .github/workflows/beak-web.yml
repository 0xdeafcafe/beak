name: beak-web

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_MARKETING_PROJECT_ID: ${{ secrets.VERCEL_MARKETING_PROJECT_ID }}

on:
  push:
    branches:
     - master
     - develop
  pull_request:
    branches:
      - '*'
    paths:
      - '.github/workflows/beak-web.yml'
      - 'package.json'
      - 'yarn.lock'
      - 'apps-web/**'
      - 'packages/**'
      - '!packages/ui/**'
      - '!packages/requester-node/**'

jobs:
  build-deploy:
    name: build and deploy
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install modules
        run: yarn install --frozen-lockfile
      - name: Lint, typecheck, and test
        run: |
          yarn lint
          yarn typecheck
          yarn test

      # New non-prod site
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        working-directory: apps-web/marketing
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v2.4.1
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Upload share to S3
        if: "startsWith(github.event.head_commit.message, 'release(')"
        uses: shallwefootball/upload-s3-action@v1.1.2
        with:
          aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_bucket: ${{ secrets.AWS_S3_BUCKET_SHARE }}
          source_dir: 'apps-web/share/dist/'
          destination_dir: ''

      - name: Upload share to S3 (nonprod)
        uses: shallwefootball/upload-s3-action@v1.1.2
        with:
          aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_bucket: ${{ secrets.AWS_S3_BUCKET_SHARE_NONPROD }}
          source_dir: 'apps-web/share/dist/'
          destination_dir: ''
